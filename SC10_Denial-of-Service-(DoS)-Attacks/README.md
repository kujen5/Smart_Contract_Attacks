# SC10 - Denial of Service (DoS) Attacks	

DoS attacks exploit vulnerabilities to exhaust contract resources or can be due to a business logic error/bug that renders it non-functional. 
Some example for this are:
- Excessive Gas Consumption in loops or function calls.
- Business logic errors that might mess with an invariant or condition rendering the contract unusable.


In this scenario, we are dealing with a competition (any kind really haha) where participants pay a small fee to be able to enter the competition. 
In order to showcase a Denial Of Service (DoS) vulnerability, I'll be showcasing two different examples.
## Example 1
In this example, when enrolling into the competition, players are asked to pay a small fees -at first-. However, this fee will keep on rising as more players enroll.

This is how the original `enterCompetition()` function looks like:
```javascript
function enterCompetition() public payable {
        require(msg.value >= ENTRANCE_FEE * s_players.length, "Must send enough money to be able to enroll.");

        for (uint256 i = 0; i < s_players.length; i++) {
            require(s_players[i] != msg.sender, "Forbidden. Player is already registered.");
        }
        s_players.push(msg.sender);
        emit DoS__NewPlayersJoinedCompetition();
    }
```

We can see that the entrance fee asked of the players is `ENTRANCE_FEE * s_players.length` which will logically increase with each new player. Therefore, we will have a Denial Of Service (DoS) of the contract once the players number is too high that no one will be able to pay the fees for it thus rendering the contract unusable.

Execution example:

```javascript
<snip>
    ├─ [0] VM::toString(100) [staticcall]
    │   └─ ← [Return] "100"
    ├─ [0] VM::addr(<pk>) [staticcall]
    │   └─ ← [Return] 100: [0xef3CDbFf03CE88F5041C82131b0cF15061b6015E]
    ├─ [0] VM::label(100: [0xef3CDbFf03CE88F5041C82131b0cF15061b6015E], "100")
    │   └─ ← [Return]
    ├─ [0] VM::deal(100: [0xef3CDbFf03CE88F5041C82131b0cF15061b6015E], 1000000000000000000 [1e18])
    │   └─ ← [Return]
    ├─ [0] VM::prank(100: [0xef3CDbFf03CE88F5041C82131b0cF15061b6015E])
    │   └─ ← [Return]
    ├─ [74817] DoS::enterCompetition{value: 1000000000000000000}()
    │   ├─ emit DoS__NewPlayersJoinedCompetition()
    │   └─ ← [Stop]
    ├─ [0] VM::toString(101) [staticcall]
    │   └─ ← [Return] "101"
    ├─ [0] VM::addr(<pk>) [staticcall]
    │   └─ ← [Return] 101: [0x7431FAA858A68387f9a0D10C04DD622fC245D34B]
    ├─ [0] VM::label(101: [0x7431FAA858A68387f9a0D10C04DD622fC245D34B], "101")
    │   └─ ← [Return]
    ├─ [0] VM::deal(101: [0x7431FAA858A68387f9a0D10C04DD622fC245D34B], 1000000000000000000 [1e18])
    │   └─ ← [Return]
    ├─ [0] VM::prank(101: [0x7431FAA858A68387f9a0D10C04DD622fC245D34B])
    │   └─ ← [Return]
    ├─ [823] DoS::enterCompetition{value: 1000000000000000000}()
    │   └─ ← [Revert] Must send enough money to be able to enroll.
@>  └─ ← [Revert] Must send enough money to be able to enroll.

<snip>
[FAIL: Must send enough money to be able to enroll.] testDenialOfService() (gas: 6280019)

```

In this test suite, we are enrolling 110 players and giving each player a starting balance of `1 ether`. After player 101 enrolls, the fee to enter the competition will become  `1.01 ether` which is higher than the players' balance of `1 ether` thus rendering entering the competition impossible which results in a Denial Of Service (DoS)

## Example 2

In this example, the players enrollment process will become through players batches where we'll enroll an array of players' addresses. 
This is how the `enterCompetition()` function looks like:
```javascript
function enterCompetition(address[] memory p_newPlayersArray) public payable {
        require(msg.value == ENTRANCE_FEE * p_newPlayersArray.length, "Must send enough money to be able to enroll.");

        for (uint256 i = 0; i < p_newPlayersArray.length; i++) {
            s_players.push(p_newPlayersArray[i]);
        }

        for (uint256 i = 0; i < s_players.length - 1; i++) {
            for (uint256 j = i + 1; j < s_players.length; j++) {
                require(s_players[i] != s_players[j], "Forbidden. Player is already registered.");
            }
        }
        emit DoS__NewPlayersJoinedCompetition();
    }
```

This time the entrance fee will not be a problem since it will be paid in full a single time. However, we can see that we have a loop that checks if a user that's entered to the competition is already a player or not. This transaction is so gas excessive that eventually with a large number of players it will result in a denial of service because the gas fees will become too high for any player to pay them.

Execution example:

<details>

```javascript
$ forge test -vvvv                                  
[⠊] Compiling...
[⠰] Compiling 21 files with Solc 0.8.19
[⠔] Solc 0.8.19 finished in 383.93ms
Compiler run successful!

Ran 1 test for test/DoSTest.sol:DoSTest
[PASS] testDenialOfService() (gas: 28639892)
Logs:
  Used gas amount:  7134122
  Used gas amount:  21425524

Traces:
  [28639892] DoSTest::testDenialOfService()
    ├─ [0] VM::txGasPrice(1)
    │   └─ ← [Return]
    ├─ [7090106] DoS::enterCompetition{value: 1000000000000000000}([0x0000000000000000000000000000000000000000, 0x0000000000000000000000000000000000000001, 0x0000000000000000000000000000000000000002, 0x0000000000000000000000000000000000000003, 0x0000000000000000000000000000000000000004, 0x0000000000000000000000000000000000000005, 0x0000000000000000000000000000000000000006, 0x0000000000000000000000000000000000000007, 0x0000000000000000000000000000000000000008, 0x0000000000000000000000000000000000000009, 0x000000000000000000000000000000000000000A, 0x000000000000000000000000000000000000000b, 0x000000000000000000000000000000000000000C, 0x000000000000000000000000000000000000000d, 0x000000000000000000000000000000000000000E, 0x000000000000000000000000000000000000000F, 0x0000000000000000000000000000000000000010, 0x0000000000000000000000000000000000000011, 0x0000000000000000000000000000000000000012, 0x0000000000000000000000000000000000000013, 0x0000000000000000000000000000000000000014, 0x0000000000000000000000000000000000000015, 0x0000000000000000000000000000000000000016, 0x0000000000000000000000000000000000000017, 0x0000000000000000000000000000000000000018, 0x0000000000000000000000000000000000000019, 0x000000000000000000000000000000000000001a, 0x000000000000000000000000000000000000001B, 0x000000000000000000000000000000000000001c, 0x000000000000000000000000000000000000001D, 0x000000000000000000000000000000000000001e, 0x000000000000000000000000000000000000001F, 0x0000000000000000000000000000000000000020, 0x0000000000000000000000000000000000000021, 0x0000000000000000000000000000000000000022, 0x0000000000000000000000000000000000000023, 0x0000000000000000000000000000000000000024, 0x0000000000000000000000000000000000000025, 0x0000000000000000000000000000000000000026, 0x0000000000000000000000000000000000000027, 0x0000000000000000000000000000000000000028, 0x0000000000000000000000000000000000000029, 0x000000000000000000000000000000000000002A, 0x000000000000000000000000000000000000002b, 0x000000000000000000000000000000000000002c, 0x000000000000000000000000000000000000002D, 0x000000000000000000000000000000000000002E, 0x000000000000000000000000000000000000002F, 0x0000000000000000000000000000000000000030, 0x0000000000000000000000000000000000000031, 0x0000000000000000000000000000000000000032, 0x0000000000000000000000000000000000000033, 0x0000000000000000000000000000000000000034, 0x0000000000000000000000000000000000000035, 0x0000000000000000000000000000000000000036, 0x0000000000000000000000000000000000000037, 0x0000000000000000000000000000000000000038, 0x0000000000000000000000000000000000000039, 0x000000000000000000000000000000000000003a, 0x000000000000000000000000000000000000003b, 0x000000000000000000000000000000000000003c, 0x000000000000000000000000000000000000003D, 0x000000000000000000000000000000000000003e, 0x000000000000000000000000000000000000003f, 0x0000000000000000000000000000000000000040, 0x0000000000000000000000000000000000000041, 0x0000000000000000000000000000000000000042, 0x0000000000000000000000000000000000000043, 0x0000000000000000000000000000000000000044, 0x0000000000000000000000000000000000000045, 0x0000000000000000000000000000000000000046, 0x0000000000000000000000000000000000000047, 0x0000000000000000000000000000000000000048, 0x0000000000000000000000000000000000000049, 0x000000000000000000000000000000000000004A, 0x000000000000000000000000000000000000004B, 0x000000000000000000000000000000000000004C, 0x000000000000000000000000000000000000004D, 0x000000000000000000000000000000000000004e, 0x000000000000000000000000000000000000004f, 0x0000000000000000000000000000000000000050, 0x0000000000000000000000000000000000000051, 0x0000000000000000000000000000000000000052, 0x0000000000000000000000000000000000000053, 0x0000000000000000000000000000000000000054, 0x0000000000000000000000000000000000000055, 0x0000000000000000000000000000000000000056, 0x0000000000000000000000000000000000000057, 0x0000000000000000000000000000000000000058, 0x0000000000000000000000000000000000000059, 0x000000000000000000000000000000000000005a, 0x000000000000000000000000000000000000005B, 0x000000000000000000000000000000000000005c, 0x000000000000000000000000000000000000005d, 0x000000000000000000000000000000000000005E, 0x000000000000000000000000000000000000005F, 0x0000000000000000000000000000000000000060, 0x0000000000000000000000000000000000000061, 0x0000000000000000000000000000000000000062, 0x0000000000000000000000000000000000000063])
    │   ├─ emit DoS__NewPlayersJoinedCompetition()
    │   └─ ← [Stop]
    ├─ [0] console::log("Used gas amount: ", 7134122 [7.134e6]) [staticcall]
    │   └─ ← [Stop]
    ├─ [21386356] DoS::enterCompetition{value: 1000000000000000000}([0x0000000000000000000000000000000000000064, 0x0000000000000000000000000000000000000065, 0x0000000000000000000000000000000000000066, 0x0000000000000000000000000000000000000067, 0x0000000000000000000000000000000000000068, 0x0000000000000000000000000000000000000069, 0x000000000000000000000000000000000000006a, 0x000000000000000000000000000000000000006b, 0x000000000000000000000000000000000000006C, 0x000000000000000000000000000000000000006D, 0x000000000000000000000000000000000000006E, 0x000000000000000000000000000000000000006F, 0x0000000000000000000000000000000000000070, 0x0000000000000000000000000000000000000071, 0x0000000000000000000000000000000000000072, 0x0000000000000000000000000000000000000073, 0x0000000000000000000000000000000000000074, 0x0000000000000000000000000000000000000075, 0x0000000000000000000000000000000000000076, 0x0000000000000000000000000000000000000077, 0x0000000000000000000000000000000000000078, 0x0000000000000000000000000000000000000079, 0x000000000000000000000000000000000000007a, 0x000000000000000000000000000000000000007B, 0x000000000000000000000000000000000000007c, 0x000000000000000000000000000000000000007d, 0x000000000000000000000000000000000000007E, 0x000000000000000000000000000000000000007f, 0x0000000000000000000000000000000000000080, 0x0000000000000000000000000000000000000081, 0x0000000000000000000000000000000000000082, 0x0000000000000000000000000000000000000083, 0x0000000000000000000000000000000000000084, 0x0000000000000000000000000000000000000085, 0x0000000000000000000000000000000000000086, 0x0000000000000000000000000000000000000087, 0x0000000000000000000000000000000000000088, 0x0000000000000000000000000000000000000089, 0x000000000000000000000000000000000000008A, 0x000000000000000000000000000000000000008b, 0x000000000000000000000000000000000000008C, 0x000000000000000000000000000000000000008D, 0x000000000000000000000000000000000000008e, 0x000000000000000000000000000000000000008F, 0x0000000000000000000000000000000000000090, 0x0000000000000000000000000000000000000091, 0x0000000000000000000000000000000000000092, 0x0000000000000000000000000000000000000093, 0x0000000000000000000000000000000000000094, 0x0000000000000000000000000000000000000095, 0x0000000000000000000000000000000000000096, 0x0000000000000000000000000000000000000097, 0x0000000000000000000000000000000000000098, 0x0000000000000000000000000000000000000099, 0x000000000000000000000000000000000000009A, 0x000000000000000000000000000000000000009b, 0x000000000000000000000000000000000000009c, 0x000000000000000000000000000000000000009D, 0x000000000000000000000000000000000000009E, 0x000000000000000000000000000000000000009F, 0x00000000000000000000000000000000000000a0, 0x00000000000000000000000000000000000000A1, 0x00000000000000000000000000000000000000A2, 0x00000000000000000000000000000000000000A3, 0x00000000000000000000000000000000000000a4, 0x00000000000000000000000000000000000000A5, 0x00000000000000000000000000000000000000a6, 0x00000000000000000000000000000000000000A7, 0x00000000000000000000000000000000000000a8, 0x00000000000000000000000000000000000000A9, 0x00000000000000000000000000000000000000AA, 0x00000000000000000000000000000000000000AB, 0x00000000000000000000000000000000000000AC, 0x00000000000000000000000000000000000000Ad, 0x00000000000000000000000000000000000000AE, 0x00000000000000000000000000000000000000Af, 0x00000000000000000000000000000000000000B0, 0x00000000000000000000000000000000000000B1, 0x00000000000000000000000000000000000000b2, 0x00000000000000000000000000000000000000b3, 0x00000000000000000000000000000000000000B4, 0x00000000000000000000000000000000000000b5, 0x00000000000000000000000000000000000000b6, 0x00000000000000000000000000000000000000b7, 0x00000000000000000000000000000000000000B8, 0x00000000000000000000000000000000000000b9, 0x00000000000000000000000000000000000000BA, 0x00000000000000000000000000000000000000bb, 0x00000000000000000000000000000000000000Bc, 0x00000000000000000000000000000000000000Bd, 0x00000000000000000000000000000000000000Be, 0x00000000000000000000000000000000000000Bf, 0x00000000000000000000000000000000000000C0, 0x00000000000000000000000000000000000000C1, 0x00000000000000000000000000000000000000c2, 0x00000000000000000000000000000000000000C3, 0x00000000000000000000000000000000000000C4, 0x00000000000000000000000000000000000000c5, 0x00000000000000000000000000000000000000c6, 0x00000000000000000000000000000000000000C7])
    │   ├─ emit DoS__NewPlayersJoinedCompetition()
    │   └─ ← [Stop]
    ├─ [0] console::log("Used gas amount: ", 21425524 [2.142e7]) [staticcall]
    │   └─ ← [Stop]
    └─ ← [Stop]
```

</details>


We can see here the calculated gas cost when we first enrolled only 100 players `7134122` and the gas cost when we later enrolled an additional 100 players `21425524`. We can notice that the gas cost for 200 players is almost 3 times the gas cost for 100 players. So we can imagine what it will be when talking about thousands of players. The contract will become unusable.


# Mitigation

For excessive gas usage DoS vulnerabilities, it is advised to stay away for loops and basically any logic that does heavy gas operations and that can be changed in the future (like number of players in our case).
As for business logic DoS vulnerabilities, just enough testing and fuzz testing should do the case of discovering these edge cases where the contract might become unusable.